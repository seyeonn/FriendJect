# ì‚¬ìš©í•œ ì œí’ˆì˜ ì¢…ë¥˜ì™€ ì„¤ì • ê°’
- ì„œë²„ : AWS EC2
- OS : Ubuntu 20.04 LTS (GNU/Linux 5.4.0-1018-aws x86_64)
- JVM : OpenJDK 8
- WAS(Web Application Server) : nginx/1.18.0 (Ubuntu) 
- DBMS : MySql 5.7.37
# ë¹Œë“œì‹œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
- DB 
  - ID : friendject
  - PW : ssafyb202t
- ë°±ì—”ë“œ ìš”ì²­ ê²½ë¡œ í™˜ê²½ë³€ìˆ˜ (ìˆ˜ì • í•„ìš”)
  - íŒŒì¼ ìœ„ì¹˜ : frontend/openvidu-insecure-vue/src/config/index.js
    - ```API_BASE_URL=http://<host>/api ```
# ë°°í¬ 
> Jenkinsë¥¼ ì´ìš©í•´ ë°°í¬ ìë™í™”ë¥¼ í•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ–± [ì„œë²„ 9090 í¬íŠ¸](http://i6b202.p.ssafy.io:9090/job/front_friendject/)
### ì  í‚¨ìŠ¤ íŒŒì´í”„ë¼ì¸
```
pipeline {
    agent any
    tools {
        git 'git'
        nodejs "node16"
    }
    stages {
        stage('prepare') {
            steps {
                sh "git --version"
                sh "node --version"
                git branch: 'develop', credentialsId: 'GitLab', url: 'https://gitlab+deploy-token-3633:bVfXzxuya_8yxuvN-ZER@lab.ssafy.com/s06-webmobile1-sub2/S06P12B202.git'
                sh "pwd"
                
                dir('frontend/openvidu-insecure-vue') {
                    sh "pwd"
                    sh "npm install"
                    sh "ls -al"
                }
                dir("backend-java") {
                    sh "pwd"
                    sh "ls -al"
                }
            }
        }
        stage('build') {
            steps {
                echo 'build'
                sh "pwd"
                dir('frontend/openvidu-insecure-vue') {
                    sh "pwd"
                    sh "npm run build"
                }
                dir("backend-java") {
                    echo "build stage"
                    sh "ls -al"
                    sh "chmod 777 ./gradlew"
                    sh "./gradlew build"
                    sh "ls -al"   
                }
            }
            post {
                success {
                    echo "success"
                    sh "pwd"
                    dir('frontend/openvidu-insecure-vue') {
                        sh "scp -r dist ubuntu@172.26.7.40:/var/www/html"
                    }
                }
            }
        }
        stage('copy jar') {
            steps {
                dir("backend-java") {
                    echo "copy jar"
                    sh "pwd"
                    sh "scp /var/jenkins_home/workspace/front_friendject/backend-java/build/libs/ssafy-web-project-1.0-SNAPSHOT.jar ubuntu@172.26.7.40:/home/ubuntu/app/backend_friendject"
                    sh "scp /var/jenkins_home/workspace/front_friendject/backend-java/src/main/resources/application.properties ubuntu@172.26.7.40:/home/ubuntu/app/backend_friendject"
                    sh "scp /var/jenkins_home/workspace/front_friendject/backend-java/Dockerfile ubuntu@172.26.7.40:/home/ubuntu/app/backend_friendject"
                    sh "scp /var/jenkins_home/workspace/front_friendject/backend-java/deploy.sh ubuntu@172.26.7.40:/home/ubuntu/app/backend_friendject"
                }
            }
            post {
                success {
                    echo "success"
                    sh "ssh ubuntu@172.26.7.40 chmod 777 /home/ubuntu/app/backend_friendject/deploy.sh"
                    sh "ssh ubuntu@172.26.7.40 /home/ubuntu/app/backend_friendject/deploy.sh"
                }
            }
        }
    }
}
```
- stage('prepare')
  - [ê¹ƒë© ë ˆí¬ì§€í† ë¦¬](https://lab.ssafy.com/s06-webmobile1-sub2/S06P12B202) í´ë¡ ë°›ê¸°
  - í”„ë¡ íŠ¸ì—”ë“œ ì‘ì—… í™˜ê²½ì˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ íŒ¨í‚¤ì§€ ì„¤ì¹˜(npm install)
- stage('build')
  - í”„ë¡ íŠ¸ì—”ë“œ ì‘ì—… í™˜ê²½ì˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ë°°í¬ë¥¼ ìœ„í•œ ë¹Œë“œ(npm run build)
  - ë°±ì—”ë“œ ì‘ì—… í™˜ê²½ì˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ë¹Œë“œ(./gradlew build)
  - ì„±ê³µì‹œ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼(dist)ì„ ì„œë²„ì˜ /var/www/html/ ìœ„ì¹˜ë¡œ ë³´ëƒ„
    - ê¶Œí•œ ë¬¸ì œë¡œ ì§ì ‘ ì˜®ê²¨ì¤Œ. (sudo cp -r dist/ /var/www/html)
- stage('copy jar')
  - ë§ˆì°¬ê°€ì§€ë¡œ ë°±ì—”ë“œì—ì„œ í•„ìš”í•œ íŒŒì¼ë“¤(jar, properties, Dockerfile, deploy)ì„ ì„œë²„ì˜ /app/backend_friendject ìœ„ì¹˜ë¡œ ë³´ëƒ„
  - ì„±ê³µí•˜ë©´ ssh ë°©ì‹ìœ¼ë¡œ deploy.sh íŒŒì¼ ì‹¤í–‰ (ë°±ì—”ë“œëŠ” ë„ì»¤ ì´ë¯¸ì§€ íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰)

### ë°±ì—”ë“œ Dockerfile, deploy.sh íŒŒì¼)
- Dockerfile
```
FROM openjdk:8-jdk-alpine
ARG JAR_FILE=*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]
```
  - jdk 8 ë²„ì „ìœ¼ë¡œë¶€í„°, .jar íŒŒì¼ì„ app.jarë¡œ ë³µì‚¬í•œ í›„ jar ì‹¤í–‰(ëª…ë ¹ì–´ : java -jar /app.jar)
- deploy.sh
```
cd /home/ubuntu/app/backend_friendject
pwd
docker build -t friendject/backend:latest .
docker container stop friendject
docker rm friendject
docker run -d --name friendject -p 8081:8081 friendject/backend
```
  - ì„œë²„ì— ì„¤ì¹˜í•œ ë°±ì—”ë“œ í´ë”ë¡œ ê°€ì„œ friendject/backend ì´ë¯¸ì§€ ìƒì„±
  - ì´ë¯¸ ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ ë©ˆì¶”ê³  ì‚­ì œí•œ í›„, ì„œë²„ì˜ 8000ë²ˆ í¬íŠ¸ì™€ ì»¨í…Œì´ë„ˆì˜ 80ë²ˆ í¬íŠ¸ë¥¼ ì—°ê²°í•´ì„œ ë‹¤ì‹œ ì‹¤í–‰ì‹œí‚¨ë‹¤.
# HTTPS ì ìš©
> certbot, letsencryptë¥¼ ì´ìš©
- certbot ì„¤ì¹˜
```
~$ sudo apt update
~$ sudo apt upgrade
~$ sudo add-apt-repository ppa:certbot/certbot

~$ sudo apt install python3-certbot-nginx
```
- nginx ì„¤ì • íŒŒì¼ ì‘ì„±
```
~$ sudo vim /etc/nginx/sites-available/default
```
![image](/uploads/d2a502e6e5d91b4c6c4328b82c252885/image.png)
  - ì„¤ì • íŒŒì¼ ì ìš©ì‹œí‚¤ê¸°(reload)
```
~$ sudo systemctl reload nginx
```
- ssl ì¸ì¦ì„œ ë°›ê¸°
![image](/uploads/5f18ddf76989fbcef1dd1f0ed00cfd50/image.png)
- nginx ì„œë²„ ì¬ì‹œì‘
```
~$ sudo service nginx restart
```
- HTTPS ì ìš© í™•ì¸
=> http://i6b202.p.ssafy.io/ ë¡œ ì ‘ì†í•´ë„ https://i6b202.p.ssafy.io/ ë¡œ ì ‘ì†í•˜ê²Œ ëœë‹¤. (ìë¬¼ì‡  ëª¨ì–‘ ì±„ì›Œì§„ ê²ƒë„ í™•ì¸ ê°€ëŠ¥!)
![image](/uploads/36349fd7cadc03672a883940dbd6a1e5/image.png)
